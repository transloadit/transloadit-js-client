#!/usr/bin/env bash

set -o pipefail
set -o errexit
set -o nounset
set -o xtrace

# Set magic variables for current file & dir
__dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
__file="${__dir}/$(basename "${BASH_SOURCE[0]}")"
__base="$(basename ${__file} .sh)"
__root="$(cd "$(dirname "${__dir}")" && pwd)"

ESBUILD="$(corepack yarn workspace @uppy-tests/end2end bin esbuild)"

# Tests using a simple build setup.
tests="chaos-monkey i18n-drag-drop providers thumbnails transloadit transloadit-assembly-options tus-drag-drop url-plugin xhr-limit"

for t in $tests; do
  mkdir -p "${__root}/test/endtoend/$t/dist"
  cp "${__root}/packages/uppy/dist/uppy.min.css" "${__root}/test/endtoend/$t/dist"
  cp "${__root}/test/endtoend/$t/index.html" "${__root}/test/endtoend/$t/dist"
  "$ESBUILD" "${__root}/test/endtoend/$t/main.mjs" \
    --bundle --target=es2017 \
    --outfile="${__root}/test/endtoend/$t/dist/bundle.js"
done

# Speeecial tests that need custom builds.
pushd "${__root}/test/endtoend/create-react-app"
  npm install
  REACT_APP_ON_TRAVIS="${TRAVIS:-}" npm run build
popd
pushd "${__root}/test/endtoend/typescript"
  mkdir -p dist
  cp "${__root}/packages/uppy/dist/uppy.min.css" dist/
  cp index.html dist/
  "$ESBUILD" "${__root}/test/endtoend/typescript/main.ts" \
    --bundle --target=es2017 \
    --outfile="${__root}/test/endtoend/typescript/dist/bundle.js"
popd
