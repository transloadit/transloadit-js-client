<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Uppy – AWS upload example</title>
    <link href="https://releases.transloadit.com/uppy/v3.3.1/uppy.min.css" rel="stylesheet">
  </head>
  <body>
    <h1>AWS upload example</h1>
    <h2>AWS S3 (non multipart)</h2>
    <div id="aws-non-multipart"></div>
    <h2>AWS S3 multipart</h2>
    <div id="aws-multipart"></div>
    <script type="module">
      import { Uppy, Dashboard, AwsS3Multipart, AwsS3 } from "https://releases.transloadit.com/uppy/v3.3.1/uppy.min.mjs"
      {
        const uppy = new Uppy()
        .use(Dashboard, {
          inline: true,
          target: '#aws-non-multipart',
        })
        .use(AwsS3, {
          getUploadParameters (file) {
            // Send a request to our Express.js signing endpoint.
            return fetch('/sign-s3', {
              method: 'post',
              // Send and receive JSON.
              headers: {
                accept: 'application/json',
                'content-type': 'application/json',
              },
              body: JSON.stringify({
                filename: file.name,
                contentType: file.type,
              }),
            }).then((response) => {
              // Parse the JSON response.
              return response.json()
            }).then((data) => {
              // Return an object in the correct shape.
              return {
                method: data.method,
                url: data.url,
                fields: data.fields, // For presigned PUT uploads, this should be left empty.
                // Provide content type header required by S3
                headers: {
                  'Content-Type': file.type,
                },
              }
            })
          },
        });
        
        uppy.on('complete', (result) => {
          console.log('Upload complete! We’ve uploaded these files:', result.successful)
        })
        
        uppy.on('upload-success', (file, data) => {
          console.log('Upload success! We’ve uploaded this file:', file.meta['name'])
        })
      }
      {
        const uppy = new Uppy()
        .use(Dashboard, {
          inline: true,
          target: '#aws-multipart',
        })
        .use(AwsS3Multipart, {
          companionUrl: window.origin,
        })
        
        uppy.on('complete', (result) => {
          console.log('Upload complete! We’ve uploaded these files:', result.successful)
        })
        
        uppy.on('upload-success', (file, data) => {
          console.log('Upload success! We’ve uploaded this file:', file.meta['name'])
        })
      }
    </script>
  </body>
</html>
