<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Uppy – AWS upload example</title>
    <link href="./uppy.min.css" rel="stylesheet" />
  </head>
  <body>
    <h1>AWS upload example</h1>
    <div id="uppy"></div>
    <footer>
      You seeing the simplified example, with a backend that mimicks a
      Companion-like instance. See
      <a href="./withCustomEndpoints.html">the custom endpoint example</a> if
      you need to see how to use one or more custom function for handling
      communication with the backend.
    </footer>
    <noscript>You need JavaScript to run this example.</noscript>
    <script type="module">
      import { Uppy, Dashboard, AwsS3 } from './uppy.min.mjs'
      /**
       * This generator transforms a deep object into URL-encodable pairs
       * to work with `URLSearchParams` on the client and `body-parser` on the server.
       */
      function* serializeSubPart(key, value) {
        if (typeof value !== 'object') {
          yield [key, value]
          return
        }
        if (Array.isArray(value)) {
          for (const val of value) {
            yield* serializeSubPart(`${key}[]`, val)
          }
          return
        }
        for (const [subkey, val] of Object.entries(value)) {
          yield* serializeSubPart(key ? `${key}[${subkey}]` : subkey, val)
        }
      }
      function serialize(data) {
        // If you want to avoid preflight requests, use URL-encoded syntax:
        return new URLSearchParams(serializeSubPart(null, data))
        // If you don't care about additional preflight requests, you can also use:
        // return JSON.stringify(data)
        // You'd also have to add `Content-Type` header with value `application/json`.
      }
      {
        const MiB = 0x10_00_00

        const uppy = new Uppy()
          .use(Dashboard, {
            inline: true,
            target: '#uppy',
          })
          .use(AwsS3, {
            id: 'myAWSPlugin',
            endpoint: '/',
            getTemporarySecurityCredentials: true,

            // Files that are more than 100MiB should be uploaded in multiple parts.
            shouldUseMultipart: (file) => file.size > 100 * MiB,
          })

        uppy.on('complete', (result) => {
          console.log(
            'Upload complete! We’ve uploaded these files:',
            result.successful,
          )
        })

        uppy.on('upload-success', (file, data) => {
          console.log(
            'Upload success! We’ve uploaded this file:',
            file.meta['name'],
          )
        })
      }
    </script>
  </body>
</html>
